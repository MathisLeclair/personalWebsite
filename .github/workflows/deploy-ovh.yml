name: Deploy Vite app to OVH Web Starter

on:
  push:
    branches: ["main"]

permissions:
  contents: read

concurrency:
  group: deploy-main
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Deploy to OVH via lftp
        env:
          OVH_SSH_PASSWORD: ${{ secrets.OVH_SSH_PASSWORD }}
          OVH_REMOTE_DIR: ${{ secrets.OVH_REMOTE_DIR }}
          OVH_SSH_HOST: ${{ secrets.OVH_SSH_HOST }}
          OVH_SSH_USER: ${{ secrets.OVH_SSH_USER }}
        run: |
          lftp -u "$OVH_SSH_USER","$OVH_SSH_PASSWORD" "sftp://$OVH_SSH_HOST" -e "
            set sftp:auto-confirm yes;
            set net:max-retries 3;
            mirror --reverse --delete --verbose dist/ $OVH_REMOTE_DIR;
            quit
          "